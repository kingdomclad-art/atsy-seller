<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atsy - Orders</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://kingdomclad-art.github.io/atsy-seller/styles.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="index.html" class="logo">Atsy</a>
            <div class="mobile-menu-btn" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="nav-links" id="navLinks">
                <a href="index.html">Dashboard</a>
                <a href="upload.html">Upload</a>
                <a href="orders.html" class="active">Orders</a>
                <a href="messages.html">Messages</a>
                <a href="insights.html">Insights</a>
                <div class="profile-icon">A</div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1>Orders</h1>
            <span style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px;">23 total orders</span>
        </div>

        <!-- Filter Tabs -->
        <div class="orders-filter">
            <button class="filter-btn active" onclick="filterOrders('all')">All</button>
            <button class="filter-btn" onclick="filterOrders('processing')">Processing</button>
            <button class="filter-btn" onclick="filterOrders('shipped')">Shipped</button>
            <button class="filter-btn" onclick="filterOrders('completed')">Completed</button>
        </div>

        <!-- Orders List -->
        <div id="orders-list">
            <!-- Loaded by JavaScript -->
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let allOrders = [];

        function toggleMenu() {
            document.getElementById('navLinks').classList.toggle('active');
        }

        async function loadOrders() {
            showLoading('orders-list');
            
            try {
                const response = await fetch(
                    `${API_BASE}/orders?order=created_at.desc`,
                    { headers: { 'apikey': API_KEY } }
                );
                const orders = await response.json();
                
                if (orders.length > 0) {
                    allOrders = orders;
                    displayOrders(orders);
                } else {
                    loadDemoOrders();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                loadDemoOrders();
            }
        }

        function loadDemoOrders() {
            allOrders = [
                {
                    order_number: 'ORD-1234',
                    product_title: 'Hand-woven Basket Set',
                    buyer_name: 'Sarah Mitchell',
                    quantity: 2,
                    total_amount: 170,
                    status: 'Processing',
                    created_at: '2026-02-18'
                },
                {
                    order_number: 'ORD-1233',
                    product_title: 'Traditional Beaded Necklace',
                    buyer_name: 'John Davidson',
                    quantity: 1,
                    total_amount: 45,
                    status: 'Shipped',
                    created_at: '2026-02-17'
                },
                {
                    order_number: 'ORD-1232',
                    product_title: 'Handcrafted Ceramic Bowl',
                    buyer_name: 'Maria Lopez',
                    quantity: 1,
                    total_amount: 120,
                    status: 'Completed',
                    created_at: '2026-02-15'
                }
            ];
            displayOrders(allOrders);
        }

        function displayOrders(orders) {
            const container = document.getElementById('orders-list');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ðŸ“¦</div>
                        <h3>No orders found</h3>
                        <p style="color: var(--neutral); margin: 10px 0;">When you receive orders, they'll appear here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => {
                // Get first two letters of product for image
                const initials = order.product_title?.substring(0,2).toUpperCase() || 'PR';
                
                // Determine action button based on status
                let actionButton = '';
                if (order.status === 'Processing') {
                    actionButton = `<button class="btn btn-small btn-primary" onclick="updateOrderStatus('${order.order_number}', 'accept')">Accept Order</button>`;
                } else if (order.status === 'Shipped') {
                    actionButton = `<button class="btn btn-small btn-success" onclick="updateOrderStatus('${order.order_number}', 'delivered')">Confirm Delivery</button>`;
                }
                
                return `
                    <div class="order-card">
                        <img src="https://ui-avatars.com/api/?name=${initials}&size=80&background=FF6B35&color=fff&length=2&bold=true&font-size=0.40" 
                             alt="${order.product_title}" 
                             class="order-image"
                             onerror="this.src='https://ui-avatars.com/api/?name=PR&size=80&background=FF6B35&color=fff'">
                        <div class="order-details">
                            <div class="order-title">${order.product_title || 'Handcrafted Item'}</div>
                            <div class="order-meta">
                                <span>Order #${order.order_number}</span>
                                <span>${formatDate(order.created_at)}</span>
                                <span>Qty: ${order.quantity || 1}</span>
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>Buyer:</strong> ${order.buyer_name}
                            </div>
                        </div>
                        <div style="text-align: right; min-width: 120px;">
                            <div style="font-size: 20px; font-weight: 600; color: var(--primary); margin-bottom: 10px;">
                                $${order.total_amount}
                            </div>
                            <span class="order-status status-${order.status.toLowerCase()}">${order.status}</span>
                            
                            <!-- Action buttons -->
                            <div style="margin-top: 10px; display: flex; gap: 5px; justify-content: flex-end;">
                                ${actionButton}
                                <button class="btn btn-small btn-outline" onclick="viewOrderDetails('${order.order_number}')">View Details</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterOrders(status) {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter orders
            if (status === 'all') {
                displayOrders(allOrders);
            } else {
                const filtered = allOrders.filter(order => 
                    order.status.toLowerCase() === status.toLowerCase()
                );
                displayOrders(filtered);
            }
        }

        function updateOrderStatus(orderNumber, action) {
            // Find the button that was clicked
            const btn = event.target;
            const originalText = btn.textContent;
            
            // Show loading state
            btn.textContent = 'Updating...';
            btn.disabled = true;
            
            // Determine new status
            let newStatus = '';
            let successMessage = '';
            
            if (action === 'accept') {
                newStatus = 'Processing';
                successMessage = `âœ… Order ${orderNumber} accepted!`;
            } else if (action === 'delivered') {
                newStatus = 'Completed';
                successMessage = `âœ… Order ${orderNumber} marked as delivered!`;
            }
            
            // Update in local array
            const orderIndex = allOrders.findIndex(o => o.order_number === orderNumber);
            if (orderIndex !== -1) {
                allOrders[orderIndex].status = newStatus;
            }
            
            // Simulate API call delay
            setTimeout(() => {
                // Refresh the display
                displayOrders(allOrders);
                
                // Show success toast
                showToast(successMessage);
            }, 800);
        }

        function viewOrderDetails(orderNumber) {
            const order = allOrders.find(o => o.order_number === orderNumber);
            if (!order) return;
            
            // Get initials for image
            const initials = order.product_title?.substring(0,2).toUpperCase() || 'PR';
            
            // Create modal HTML
            const modalHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000;" onclick="this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2 style="margin-bottom: 20px; color: var(--primary);">Order Details</h2>
                        
                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <img src="https://ui-avatars.com/api/?name=${initials}&size=100&background=FF6B35&color=fff&length=2&bold=true" 
                                 style="width: 100px; height: 100px; border-radius: 8px; object-fit: cover;">
                            <div>
                                <p style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">${order.product_title}</p>
                                <p style="color: var(--neutral);">Order #${order.order_number}</p>
                                <p style="color: var(--neutral);">Buyer: ${order.buyer_name}</p>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: var(--gray-100); padding: 15px; border-radius: 8px;">
                            <div>
                                <p style="color: var(--neutral); font-size: 12px; margin-bottom: 5px;">QUANTITY</p>
                                <p style="font-weight: 600; font-size: 16px;">${order.quantity || 1}</p>
                            </div>
                            <div>
                                <p style="color: var(--neutral); font-size: 12px; margin-bottom: 5px;">AMOUNT</p>
                                <p style="font-weight: 600; font-size: 16px; color: var(--primary);">$${order.total_amount}</p>
                            </div>
                            <div>
                                <p style="color: var(--neutral); font-size: 12px; margin-bottom: 5px;">STATUS</p>
                                <p><span class="order-status status-${order.status.toLowerCase()}">${order.status}</span></p>
                            </div>
                            <div>
                                <p style="color: var(--neutral); font-size: 12px; margin-bottom: 5px;">DATE</p>
                                <p>${new Date(order.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="color: var(--neutral); font-size: 12px; margin-bottom: 5px;">SHIPPING ADDRESS</p>
                            <p style="background: var(--gray-100); padding: 10px; border-radius: 8px;">123 Main Street, Lagos, Nigeria</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="color: var(--neutral); font-size: 12px; margin-bottom: 5px;">ORDER NOTES</p>
                            <p style="background: var(--gray-100); padding: 10px; border-radius: 8px;">Please handle with care. This is a gift.</p>
                        </div>
                        
                        <button class="btn btn-primary" style="width: 100%;" onclick="this.closest('div[style*="background"]').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function formatDate(dateString) {
            const options = { month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        // Load orders when page loads
        loadOrders();
    </script>
</body>
</html>